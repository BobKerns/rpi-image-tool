#!/bin/bash

### This is the script that runs at container startup.
### It mounts the specified disk image file, then runs
### the supplied command.

WDIR="/data"

IMG=$1
shift

usage() {
    msg "Usage: $0 <img file> <cmd> <args*>" 1>&2
    msg "  Root and boot filesystems will be mounted under ${WDIR}/build/root" 1>&2
    msg "  and the supplied command will be executed." 1>&2
    exit 255
}

if [ "$IMG" = "bash" ]; then
    # Allow running bash w/o an image, to explore the container
    exec bash
elif [ -z "$IMG" ]; then
    usage
fi

cd /data/local

if [ ! -r "$IMG" ]; then
    msg "Cannot find image file ${IMG}"
    exit 2
fi

if [ -z "$*" ]; then
    usage
fi

. ${WDIR}/bin/inc/vars.sh

do_mount_all


msg "RUN: $@"
"$@"
msg "DONE: Exit $?"

# Happens automatically on exit or SIGINT
#do_unmount_all
