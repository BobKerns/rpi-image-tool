#!/bin/bash

#### This is the script that runs at container startup.
#### It mounts the specified disk image file, then runs
#### the supplied command.
####
#### Usage: ${PI_INVOKER} <cmd> <args*>
####   Root and boot filesystems will be mounted under ${PI_ROOT} and ${PI_BOOT}
####   and the supplied command will be executed.
####

export PI_INCLUDES="$(cd "$(dirname "$0")"; pwd)"
. "${PI_INCLUDES}/vars.sh"

export PI_INVOKER="${PI_INVOKER:-"$(basename "$0")"}"

case "$1" in
    --debug|-d|-vv)
        export PI_VERBOSE=yes
        export PI_DEBUG=yes
        shift
        ;;
    --verbose|-v)
        export PI_VERBOSE=yes
        shift
        ;;
    --help|'-?')
        usage
        ;;
esac

# Harmonize relative paths
cd /data/local
if [ -z "$*" ]; then
    usage
fi

# Allow these to be regular commands
enable -n help
enable -n export

verbose "RUN: $@"
"$@"
status=$?
if [ "${status}" = 127 ]; then
    msg ERROR: "$1 not found."
elif [ "${status}" != 0 ]; then
    errmsg="$(errno "${status}" || echo "${status}")"
    msg ERROR: "${errmsg}"
else
    verbose "DONE: Exit OK"
fi

# Happens automatically on exit or SIGINT
#do_unmount_all

exit "${status}"
