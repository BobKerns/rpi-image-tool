#!/bin/bash

### This is the script that runs at container startup.
### It mounts the specified disk image file, then runs
### the supplied command.

export WDIR="/data"

export INVOKER="${INVOKER-"$(basename "$0")"}"

usage() {
    echo "Usage: ${INVOKER} <cmd> <args*>" 1>&2
    echo "  Root and boot filesystems will be mounted under ${WDIR}/build/root" 1>&2
    echo "  and the supplied command will be executed." 1>&2
    exit 255
}

case "$1" in
    --debug|-d|-vv)
        DEBUG=yes
        VERBOSE=yes
        shift
        ;;
    --verbose|-v)
        VERBOSE=yes
        shift
        ;;
    --help|'-?')
        usage
        ;;
esac

export USER_IMG="$1"
export USER_PWD="$(pwd)"
shift

export CMDDIR="${WDIR}/bin"
export INCDIR="${CMDDIR}/inc"
export VARS_IMPORT="${INCDIR}/vars.sh"
. "${VARS_IMPORT}"


if [ "$USER_IMG" = "bash" ]; then
    # Allow running bash w/o an image, to explore the container
    exec bash
elif [ -z "$USER_IMG" ]; then
    usage
fi

# Harmonize relative paths
cd /data/local

if [ -z "$*" ]; then
    usage
fi

if [ -r "/data/img" ]; then
    export IMG="/data/img"
    do_mount_all
elif [ "${USER_IMG}" = '-' ]; then
    export IMG=
elif [ -r "$IMG" ]; then
    export IMG="${USER_IMG}"
    do_mount_all
else
    msg "Cannot find image file ${USER_IMG}"
    exit 2
fi

enable -n help

verbose "RUN: $@"
"$@"
status=$?
if [ "${status}" = 127 ]; then
    msg ERROR: "$1 not found."
elif [ "${status}" != 0 ]; then
    errmsg="$(errno "${status}" || echo "${status}")"
    msg ERROR: "${errmsg}"
else
    verbose "DONE: Exit OK"
fi

# Happens automatically on exit or SIGINT
#do_unmount_all

exit "${status}"
