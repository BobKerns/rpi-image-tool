#!/bin/bash

### This is the script that runs at container startup.
### It mounts the specified disk image file, then runs
### the supplied command.

WDIR="/data"

IMG=$1
shift
usage() {
    echo "Usage: $0 <img file> <cmd> <args*>" 1>&2
    echo "  Root and boot filesystems will be mounted under ${WDIR}/build/root" 1>&2
    echo "  If the current directory is mounted to ${WDIR}/local," 1>&2
    echo "  the relative img file path will be the same in both environments" 1>&2
    echo "  and the bin/ subdirectory will be at ${WDIR}/local/bin and on the path" 1>&2
    exit 255
}

if [ "$IMG" = "bash" ]; then
    # Allow running bash w/o an image, to explore the container
    exec bash
elif [ -z "$IMG" ]; then
    usage
fi

cd /data/local

if [ ! -r "$IMG" ]; then
    echo "Cannot find image file ${IMG}"
    exit 2
fi

if [ -z "$*" ]; then
    usage
fi

. ${WDIR}/bin/inc/vars.sh

do_mount_all

"$@"

# Happens automatically on exit or SIGINT
#do_unmount_all
