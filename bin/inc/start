#!/bin/bash

### This is the script that runs at container startup.
### It mounts the specified disk image file, then runs
### the supplied command.

export WDIR="/data"

export USER_IMG=$1
export USER_PWD="$(pwd)"
shift

. ${WDIR}/bin/inc/vars.sh

usage() {
    msg "Usage: $0 <img file> <cmd> <args*>" 1>&2
    msg "  Root and boot filesystems will be mounted under ${WDIR}/build/root" 1>&2
    msg "  and the supplied command will be executed." 1>&2
    exit 255
}

if [ "$USER_IMG" = "bash" ]; then
    # Allow running bash w/o an image, to explore the container
    exec bash
elif [ -z "$USER_IMG" ]; then
    usage
fi

# Harmonize relative paths
cd /data/local

if [ -z "$*" ]; then
    usage
fi

if [ -r "/data/img" ]; then
    export IMG="/data/img"
elif [ -r "$IMG" ]; then
    export IMG="${USER_IMG}"
else
    msg "Cannot find image file ${USER_IMG}"
    exit 2
fi

do_mount_all

msg "RUN: $@"
"$@"
msg "DONE: Exit $?"

# Happens automatically on exit or SIGINT
#do_unmount_all
