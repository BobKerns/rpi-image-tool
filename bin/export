#!/bin/bash

#### Export a tar file for import with the docker import command.
#### Usage ${PI_INVOKER} $(basename "$0") [outfile]

. "${PI_CMDS}/inc/vars.sh"

find_partitions

EXCLUDE=(
    "dev/*"
    "proc/*"
    "sys/*"
    "tmp/*"
    "run/*"
    "mnt/*"
    "media/*"
    "var/run"
    "var/lock"
    "var/spool"
    "var/cache"
    "lost+found"
    )
EXCLUDES=()
for E in "${EXCLUDE[@]}"; do
    EXCLUDES+=(--exclude "${E}")
done

DFLT="$(basename "${PI_USER_IMAGE_FILE-"${PI_IMAGE_FILE-out}"}" .img).${EPOCHREALTIME}.tar"

OUT="${1-$DFLT}"
shift


tar --create --file "${OUT}" "${EXCLUDES[@]}" -C "${PI_ROOT}" --checkpoint=5000 --checkpoint-action='echo=%u %T%*\r' .
