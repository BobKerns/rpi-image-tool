#!/bin/bash

#### Create a docker image to run the current image file.
#### Any pending changes will be committed first.
####   Usage: ${PI_INVOKER} [<imageName>]
####     The default for <imageName> is pi:latest

export PI_CMD="$0"
DIR="$(dirname "$(dirname "${PI_CMD}")")"
export PI_INCLUDES="${DIR}/inc"
BIN="${DIR}/bin"
PI_PLATFORM="${PI_PLATFORM:-"linux/arm64"}"

. "${PI_INCLUDES}/vars.sh"

case "${1}" in
    --platform)
        PI_PLATFORM="${2}"
        shift 2
        ;;
esac

NAME="${1-pi:latest}"
shift

echo "Creating docker image ${NAME} from the current disk image"
echo "This will take some time."

"${BIN}/rpi-image-tool" commit

msg "Exporting files and importing into docker container ${NAME}"
"${BIN}/rpi-image-tool" export-docker - \
| docker import - "${NAME}" --platform "${PI_PLATFORM}" "$@" \
|| error "Export failed." || exit

msg "The image can be run via ${BIN}/pi ${NAME}"
