#!/bin/bash

#### Create a docker image to run the current image file.
#### Any pending changes will be committed first.
####   Usage: ${PI_INVOKER}

set -x
export PI_CMD="$0"
DIR="$(dirname "$(dirname "${CMD}")")"
export PI_INCLUDES="${DIR}/inc"
BIN="${DIR}/bin"

. "${PI_INCLUDES}/vars.sh"

PI_IMAGE_FILE="$1"
shift
NAME="${1-pi:latest}"
shift

echo "Creating docker image ${NAME} from disk image ${PI_IMAGE_FILE}"
echo "This will take some time."

"${BIN}/rpi-image-tool" commit

"${BIN}/rpi-image-tool" export-docker - | docker import - "${NAME}" "$@"

msg "The image can be run via ${BIN}/pi ${NAME}"
