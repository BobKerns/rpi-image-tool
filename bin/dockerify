#!/bin/bash

# Produce a .tar file suitable for the docker import command.
#  usage: rpi-image-tool rpi-distro.img dockerify rpi-distro.tar

EXCLUDE=("dev/*" "proc/*" "sys/*" "tmp/*" "run/*" "mnt/*" "media/*" "lost+found")
EXCLUDES=()
for E in "${EXCLUDE[@]}"; do
    EXCLUDES+=(--exclude "${E}")
done

DFLT="$(basename $IMG .img).tar"

OUT="${1-$DFLT}"
shift

if [ "${OUT}" = "-" ]; then
    tar --create --to-stdout "${EXCLUDES[@]}" -C "${ROOTDIR}" --checkpoint=5000 --checkpoint-action='ttyout=%u %T%*\r' .
else
    tar --create --file "${OUT}" "${EXCLUDES[@]}" -C "${ROOTDIR}" --checkpoint .
fi
