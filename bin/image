#!/bin/bash

#### Load an image file to be configured.
#### Usage:
####   ${PI_INVOKER} $(basename "$0") <imagefile>
####      Load the <imagefile> into the work volume
####   ${PI_INVOKER} $(basename "$0") --clean
####       Clear the work volume.
####       This deletes all the files in the work volume. If you specify the work volume
####       manually, be certain you specify the correct one.

. "${PI_CMDS}/inc/vars.sh"

CLEAN=

case "$1" in
    ''|--help)
        usage
        exit
        ;;
    --clear|--clean)
        CLEAN=yes
        ;;
    *)
        shift
        ;;
esac


if [ ! -z "${CLEAN}" ]; then
    msg "Emptying volume ${PI_VOLUME}"
    rm -rf /work/*
else
    if [ ! -r "${PI_IMAGE_SRC_MOUNT}" ]; then
        msg "No image file supplied."
        usage
    fi
    ext="${PI_USER_IMAGE_FILE: -4}"
    if [ "${ext^^}" = '.ZIP' ]; then
        file="$(zipinfo -1 "${PI_IMAGE_SRC_MOUNT}" | head -1)"
        msg extracting "${PI_USER_IMAGE_FILE}/${file}" to "${PI_IMAGE_FILE}"
        unzip -p "${PI_IMAGE_SRC_MOUNT}" "${file}" >"${PI_IMAGE_FILE}"
    else
        msg Copying "${PI_IMAGE_SRC_MOUNT}" to "${PI_IMAGE_FILE}"
        cp -fv "${PI_IMAGE_SRC_MOUNT}" "${PI_IMAGE_FILE}"
    fi
    chmod a+w "${PI_IMAGE_FILE}"
fi
