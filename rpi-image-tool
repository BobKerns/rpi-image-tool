#!/bin/bash

# This script bind-mounts the current directory into a privileged container to
# run the supplied script with the supplied image mounted

# Compute the absolute path for a possibly-relative pathname.
abspath() {
    if [[ -d "$1" ]]; then
        (cd "$1"; pwd)
    else
        (cd "$(dirname "$1")"; echo "$(pwd)/$(basename "$1")")
    fi
}

# The script to run in the container.
DFLT_BUILDER='rpiimagetool'
export PI_BUILDER=${PI_BUILDER:-"${DFLT_BUILDER}"}

export PI_VOLUME_SUFFIX=default

export PI_INVOKER_BASE="$(basename "$0")"
export PI_INVOKER="${PI_INVOKER_BASE} [--verbose|--debug] [--interactive] [--builder scriptname] [--volume volname]"
# Should be the same as in vars.sh
export PI_IMAGE_SRC_MOUNT=/data/image
export PI_TMP=/work/tmp

export PI_TERM="${TERM}"

# Parse any supplied options.
declare -a options=()
INTERACTIVE="-i"
while [ -z "${SUBCMD}" -a ! -z "$*" ]; do
    case "$1" in
        --interactive|-i)
            INTERACTIVE="-it"
            export PI_INTERACTIVE=yes
            shift
            ;;
        --verbose|-v)
            # We will pass these on
            options+=(--verbose)
            shift
            ;;
        --debug|-d|-vv)
            # We will pass these on
            options+=(--debug)
            shift
            ;;
        --builder|-b)
            shift
            export PI_BUILDER="$1"
            shift
            ;;
        --volume)
            shift
            export PI_VOLUME_SUFFIX="$1"
            shift
            ;;
        --nomount)
            shift
            export PI_NO_MOUNT=yes
            options+=(--nomount)
            ;;
        --term)
            shift
            export PI_TERM="${1:?}"
            shift
            ;;
        --help|'-?')
            shift
            options+=(--help)
            export PI_INVOKER="$(basename "$0")"
            SUBCMD=help
            ;;
        help)
            export PI_INVOKER="$(basename "$0")"
            SUBCMD=help
            ;;
        image|export-image|create-image)
            SUBCMD="$1"
            # We need to mount the image file
            export PI_IMAGE_ARG="$2"
            export PI_IMAGE_SRC_MOUNT="/data/$(basename "${PI_IMAGE_ARG}")"
            ;;
        *)
            SUBCMD="$1"
            ;;
        esac
done

# Update PI_INVOKER with mandatory args
U_BUILDER=
U_VOLUME=
if [ "${PI_BUILDER}" != "${DFLT_BUILDER}" ]; then
    U_BUILDER=" --builder '${PI_BUILDER}'"
fi
if [ "${PI_VOLUME_SUFFIX}" != default ]; then
    U_VOLUME=" --volume '${PI_VOLUME_SUFFIX}'"
fi
export PI_INVOKER="${PI_INVOKER_BASE} [--verbose|--debug] [--interactive]${U_BUILDER}${U_VOLUME}"

# Special case known interactive programs. In these cases, we want a PTY allocated

case "$1" in
    bash)
        if [ "$*" = 'bash' ]; then
            ## Only if no arguments (e.g. scripts)
            export PI_INTERACTIVE=yes
        fi
        ;;
    emacs|vi|nano)
        export PI_INTERACTIVE=yes
        ;;
    '')
        set -- bash
        export PI_INTERACTIVE=yes
esac

if [ ! -z "${PI_INTERACTIVE}" ]; then
    INTERACTIVE='-it'
fi

export PI_USER_IMAGE_FILE="${PI_IMAGE_ARG}"
export PI_USER_CWD="$(pwd)"
export PI_USER_NAME="$(whoami)"
export PI_VOLUME="pi-image-tool-vol_${PI_VOLUME_SUFFIX}"

declare -a mounts exports mount_args export_args
mounts=()
exports=(
    PI_USER_CWD
    PI_USER_NAME
    PI_USER_IMAGE_FILE
    PI_INVOKER_BASE
    PI_INVOKER
    PI_INTERACTIVE
    PI_BUILDER
    PI_VOLUME_SUFFIX
    PI_VOLUME
    PI_TMP
    )
mount_args=(
    -v"${PWD}:/data/local"
    --mount "type=volume,source=${PI_VOLUME},destination=/work"
)
export_args=()

if [ "${PI_IMAGE_ARG}" != '-' -a ! -z "${PI_IMAGE_ARG}" -a -r "${PI_IMAGE_ARG}" ]; then
    export PI_IMAGE_USER_ABSOLUTE="$(abspath "${PI_IMAGE_ARG}")"
    mounts+=(type=bind,source="${PI_IMAGE_USER_ABSOLUTE},target=${PI_IMAGE_SRC_MOUNT}")
    exports+=(PI_IMAGE_USER_ABSOLUTE PI_IMAGE_SRC_MOUNT)
fi

for i in  "${mounts[@]}"; do
    mount_args+=(--mount "${i}")
done

for i in  "${exports[@]}"; do
    export_args+=(--env "${i}")
done

CIDFILE="/tmp/$$.cid"
killContainer() {
    local CID="$(cat "${CIDFILE}")"
    rm "${CIDFILE}"
    echo "Stopping ${CID}" 1>&2
    docker stop -t 5 "${CID}" >/dev/null 2>&1
    exit 255
}

if [ "${INTERACTIVE}" = '-it' ]; then
    docker run --privileged --rm $INTERACTIVE \
        "${mount_args[@]}" \
        "${export_args[@]}" \
        --tmpfs "${PI_TMP}:rw,noexec,nosuid,size=100M" \
        "${PI_BUILDER}" "${options[@]}" --term "${PI_TERM}" "$@"
else
    # When not in interactive mode, run docker in the background so that bash
    # can handle SIGINT and stop the container.
    trap killContainer INT
    docker run --privileged --rm $INTERACTIVE \
        --cidfile "${CIDFILE}" \
        "${mount_args[@]}" \
        "${export_args[@]}" \
        --tmpfs "${PI_TMP}:rw,noexec,nosuid,size=100M" \
        "${PI_BUILDER}" "${options[@]}" "$@" &
    wait $!
fi
